require File.expand_path(File.dirname(__FILE__) + '/../test_helper')
require File.expand_path(File.dirname(__FILE__) + '/integration_test_helper')

class AccessControlTest < ActionDispatch::IntegrationTest
  include IntegrationTestHelper

  def setup
    @account = default_account
    default_account.update_attributes! :allow_email_domain_lockdown => false
    @site = default_site
    @site.update_attributes! :global_access => false
    @entry = @site.ip_white_list_entries.create! :description => 'test', :address => '127.0.0.1', :netmask => '255.255.255.255'
    # https://github.com/binarylogic/authlogic/issues/262#issuecomment-1804988
    @user = User.make :lead
    @user.save_without_session_maintenance
  end

  def test_do_not_block_access
    session = login @user

    session.get "/workflows"
    session.assert_response :success
  end

  def test_block_access
    session = login @user

    @entry.update_attributes! :address => '1.1.1.1'

    session.get "/workflows"
    session.assert_response :redirect
    session.assert_redirected_to workflows_path
    assert_equal "You do not have access to PackManager from this location.", session.flash[:error]
    assert_equal false, session.cookies["user_credentials"].include?(@user.reload.persistence_token)
  end

  test "should redirect to the workflows page when user is logged in" do
    session = login @user
    session.get '/quotes'
    session.assert_response :redirect
    session.assert_redirected_to '/workflows'
    assert_equal "Permission denied. Your account cannot access the requested page.", session.flash[:error]
  end
end
